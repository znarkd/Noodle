<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Noodle</title>
  <meta name="description" content="Noodle database" />
  <meta name="keywords" content="ARMR, Noodle, data, database" />
  <meta name="author" content="Dan Kranz" />
  <link rel="icon" type="image/png" href="favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"/>
  <link rel="stylesheet" href="https://unpkg.com/normalize.css/normalize.css" type="text/css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/font-awesome/css/font-awesome.min.css" crossorigin="anonymous" />
  <script src="https://unpkg.com/react/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-virtualized/dist/umd/react-virtualized.js" crossorigin="anonymous"></script>
  <script src="libs/Roots.js"></script>
  <script src="libs/Noodle.js"></script>
  <script src="libs/NoodleDatabase.js"></script>

  <style>
    html,
    body {
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      position: fixed;
    }

    .hide {
      display: none !important
    }
    
    .app {
      height: 100%;
      width: 100%;
    }

    .open {
      flex: 1;
      align-self: stretch;
      align-items: center;
      flex-direction: column;
      background: #282c34;
      background: var(--background-color);
    }

    .open,
    .open__icons {
      display: flex;
      justify-content: center
    }

    .open__icons {
      align-items: stretch;
      flex-direction: row;
      flex-shrink: 0;
      flex-wrap: wrap
    }

    .open--drag .open__icons {
      display: none
    }

    .open__icon {
      text-align: center;
      cursor: pointer;
      margin: 20px;
      transition: color .15s ease
    }

    .open__icon:hover {
      color: #abb2bf;
      color: var(--medium-color)
    }

    .open__icon-i,
    .open__icon-svg {
      font-size: 4em
    }

    .open__icon-text {
      color: #4f545e;
      color: var(--muted-color)
    }

    .open__icon:hover>.open__icon-text {
      color: #abb2bf;
      color: var(--medium-color)
    }

    .open__icon-svg {
      line-height: 0
    }

    .open__icon-svg>svg {
      height: 1em;
      width: 1em
    }

    .edit-screen {}

    .navbar {
      width: 100%;
      height: 41px;
      overflow: hidden;
      white-space: nowrap;
      color: #f1f1f1;
      background-color: #5f5f5f;
      overflow: hidden;
    }

    .navbar a {
      float: left;
      font-size: 1.5em;
      color: white;
      text-align: center;
      padding: 7px 20px;
      text-decoration: none;
    }

    #pagecount,
    #screentitle {
      float: left;
      font-size: 1.25em;
      color: white;
      text-align: center;
      padding: 7px 20px;
    }

    .dropdown {
      float: left;
      overflow: hidden;
    }

    .dropdown .dropbtn {
      font-size: 1.5em;
      border: none;
      outline: none;
      color: white;
      padding: 7px 20px;
      background-color: inherit;
      font-family: inherit;
      margin: 0;
    }

    .navbar a:hover,
    .dropdown:hover .dropbtn {
      background-color: #990000;
      cursor: pointer;
    }

    .dropdown-content {
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 1;
    }

    .dropdown-content a {
      float: none;
      color: black;
      padding: 7px 14px;
      text-decoration: none;
      display: block;
      text-align: left;
      font-size: 1em;
    }

    .dropdown-content a:hover {
      background-color: #ddd;
    }

    .right-nav {
      float: right;
    }

    .edit-display {
      top: 41px;
      position: fixed;
      width: 100%;
      height: calc(100% - 41px);
      background-color: lightgray;
    }

    .header {
      max-height: 100px;
      width: 100%;
      padding-top: 6px;
      background-color: lightgray;
      display: flex;
      flex-wrap: wrap;
      white-space: normal;
      overflow: auto;
    }

    .header_field {
      margin-left: 14px;
      padding-right: 4px;
      white-space: nowrap;
      font-weight: normal;
      color: darkblue;
    }

    .header_field input {
      margin-right: 4px;
      margin-bottom: 4px;
      color: black;
      zzzdisplay: block;
      zzz-moz-box-sizing: border-box;
      zzz-webkit-box-sizing: border-box;
      zzzbox-sizing: border-box;
    }

    .detail {
      background-color: white;
      width: auto;
      height: calc(100% - 110px);
    }

    .detail_grid {
      border-top: 2px solid white;
      border-bottom: 2px solid white;
      background-color: lightgray;
    }

    .evenCell,
    .oddCell {
      display: flex;
      align-items: center;
      border-right: 1px solid #d9dddd;
      border-bottom: 1px solid #d9dddd;
    }

    .evenCell {
      background-color: #f4f4f4;
    }

    .oddCell {
      background-color: white;
    }
  </style>
</head>

<body>
  <div class="app">
    <div id="open-screen" class="open">
      <div class="open__icons">
        <div class="open__icon open__icon-open">
          <i class="fa fa-lock open__icon-i"></i>
          <div class="open__icon-text">Open</div>
        </div>
        <div class="open__icon open__icon-new">
          <i class="fa fa-plus open__icon-i"></i>
          <div class="open__icon-text">New</div>
        </div>
        <div class="open__icon open__icon-demo" onclick="showDemo()">
          <i class="fa fa-magic open__icon-i"></i>
          <div class="open__icon-text">Demo</div>
        </div>
        <div class="open__icon open__icon-storage svg-btn" data-storage="gdrive" onclick="gdrive()">
          <div class="open__icon-svg"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128"><path d="M86.657536,76.246208 L47.768064,9 L89.111168,9 L128,76.246208 L86.657536,76.246208 Z M25.010048,119.08 L102.690048,119.08 L123.36256,83.24 L45.68064,83.24 L25.010048,119.08 L25.010048,119.08 Z M38.793088,9.003712 L0,76.30496 L20.671872,112.110016 L59.464704,44.808128 L38.793088,9.003712 Z"></path></svg></div>
          <div class="open__icon-text">Google Drive</div>
        </div>
        <div class="open__icon open__icon-more">
          <i class="fa fa-ellipsis-h open__icon-i"></i>
          <div class="open__icon-text">More</div>
        </div>
      </div>
    </div>
    <div id="edit-screen" class="edit-screen hide">
      <div id="navbar" class="navbar">
        <div class="dropdown">
          <button class="dropbtn" onclick="toggleMenu();"><i class="fa fa-bars"></i></button>
          <div id="dropdown-content" class="dropdown-content hide">
            <a onclick="doReport();">Export as XML</a>
            <a onclick="doExport();">Export as CSV</a>
            <a href="#">Link 3</a>
          </div>
        </div>
        <a id="next_page" onclick="leftArrowClick();"><i class="fa fa-arrow-left"></i></a>
        <a id="prev_page" onclick="rightArrowClick();"><i class="fa fa-arrow-right"></i></a>
        <span id="pagecount">Page nnn of mmm</span>
        <span id="screentitle">A description of the screen contents</span>
        <div class="right-nav">
          <a id="trash" onclick="trashClick();"><i class="fa fa-trash"></i></a>
          <a id="search" onclick="searchClick();"><i class="fa fa-search"></i></a>
        </div>
      </div>
      <div id="edit-display" class="edit-display">
        <div id="header" class="header">
        </div>
        <div id="detail" class="detail">
        </div>
      </div>
    </div>
  </div>

  <script type="application/javascript">
    var db1;

    // Screen layouts
    var editScreen = [];
    var currentScreen = 0;
    var SCREEN_GET = 1;
    var SCREEN_SORT = 2;

    // Data view
    var view = {};
    view.hedlin = 0;
    view.bfihed = [];
    view.collin = 0;
    view.bficol = [];
    view.npage = 0;
    view.curpag = 0;

    var showDemo = function() {
      document.getElementById("open-screen").classList.toggle("hide", true);

      // Prepare a large data set

      var zData = [];
      var i, d;
      var letters = [
        'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',
        'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'
      ];
      var noyes = ["No", "Yes"]

      for (i = 0; i < 20000; i++) {
        d = (zData[i] = {});
        d["Seq"] = i + 1;
        d["Char1"] = letters[Math.floor(Math.random() * 26)];
        d["YN"] = noyes[Math.floor(Math.random() * 2)];
        d["String3"] = letters[Math.floor(Math.random() * 26)] +
          letters[Math.floor(Math.random() * 26)] +
          letters[Math.floor(Math.random() * 26)];
        d["RNum"] = Math.random() * 10000;
        d["Num"] = Math.floor((Math.random() * 100) + 1);
        d["Date"] = Date.now();
        d["Count"] = 1;
      }

      db1 = new Noodle(zData);

      // Create a sample edit screen for the demo

      editScreen[0] = {
        "name": "Rows by Char1 and YN",
        "header": [{
            "field": "Char1"
          },
          {
            "field": "YN",
            "width": 10
          },
          {
            "field": "Count"
          },
          {
            "field": "Count"
          },
          {
            "field": "Count"
          },
          {
            "field": "Count"
          }
        ],
        "columns": [{
            "field": "Seq",
            "width": 50
          },
          {
            "field": "String3"
          },
          {
            "field": "RNum"
          },
          {
            "field": "Date"
          }
        ]
      };

      // Show the screen
      showEditScreen();
    }
    
    var gdrive = function() {
    }

    var ScreenGet = function() {}

    var showEditScreen = function() {
      if (db1 === undefined)
        return;

      // Initialize the screen menu
      RemoveScreensFromMenu();

      currentScreen = 1;
      ShowNewScreen(SCREEN_GET | SCREEN_SORT);
    }

    var coslay = function() {

      var i;

      if (currentScreen < 1)
        return false;

      // Extract header fields
      if (editScreen[currentScreen - 1].header != undefined)
        view.hedlin = editScreen[currentScreen - 1].header.length;
      else
        view.hedlin = 0;
      for (i = 0; i < view.hedlin; i++) {
        view.bfihed[i] = db1.BFI(editScreen[currentScreen - 1].header[i].field);
      }

      // Extract columnar fields
      if (editScreen[currentScreen - 1].columns != undefined)
        view.collin = editScreen[currentScreen - 1].columns.length;
      else
        view.collin = 0;
      for (i = 0; i < view.collin; i++) {
        view.bficol[i] = db1.BFI(editScreen[currentScreen - 1].columns[i].field);
      }

      //alert(JSON.stringify(view));
      return true;
    }

    var BuildView = function() {

      var i;

      // Translate the screen file
      if (!coslay())
        return false;

      // Set the data base view
      db1.InitializeView();
      for (i = 0; i < view.hedlin; i++) {
        //if (screen.layout->hAttribute[i].style & ATTR_SUMMARY)
        //	db1.EnterHeaderSum(view.bfihed[i]);
        //else
        db1.EnterHeader(view.bfihed[i]);
      }
      for (i = 0; i < view.collin; i++) {
        //if (screen.layout->cAttribute[i].style & ATTR_SUMMARY)
        //	db1.EnterColumnarSum(view.bficol[i]);
        //else
        db1.EnterColumnar(view.bficol[i]);
      }
      db1.GenerateView();

      view.npage = db1.PageCount();
      view.curpag = 1;
      //view.lineCount = db1.LineCount(1);
      return true;
    }

    var BuildForm = function() {
      BuildHeader(view.bfihed, 0);
      BuildDetail(view.bficol, 0);
    }

    var FillPage = function() {

      //	Fill the header portion
      if (view.hedlin)
        FillHeader(view.curpag, view.npage, view.bfihed, view.hedlin);

      //	Fill the columnar portion
      if (view.collin)
        FillColumns(view.curpag, view.npage, view.bficol, view.collin);
    }

    var RemoveScreensFromMenu = function() {}

    var ShowNewScreen = function(nFlags) {
      // Get the currently selected screen to display
      if (nFlags & SCREEN_GET)
        ScreenGet();

      //if (screen.layblk.nline)
      //	screen.quiet = false;

      // Sort the data based on the screen layout
      if (nFlags & SCREEN_SORT)
        BuildView();

      // Create a form for displaying the data view and display the first page of data.
      BuildForm();

      document.getElementById("screentitle").innerText = editScreen[currentScreen - 1].name;
      document.getElementById("edit-screen").classList.toggle("hide", false);

      // Load data into the newly created screen page
      FillPage();
    }

    var BuildHeader = function(bfi, attr) {
      var i, s, field, field_input, nline = bfi.length;
      var header = document.getElementById("header");
      var detail = document.getElementById("detail");
      var child;

      // Delete old header input fields
      while (header.firstChild !== null) {
        child = header.firstChild;
        header.removeChild(child);
      }

      // Hide the header when there are no header input fields
      if (nline == 0) {
        document.getElementById("header").classList.toggle("hide", true);
        document.getElementById("next_page").classList.toggle("hide", true);
        document.getElementById("prev_page").classList.toggle("hide", true);
        return;
      }

      // Build the new header input fields
      for (i = 0; i < nline; i++) {
        field = document.createElement("span");
        field.className = "header_field";

        s = encodeURIComponent(db1.FieldName(bfi[i])) + " ";
        field.innerHTML = s;

        field_input = document.createElement("input");
        s = "hedit" + i;
        field_input.setAttribute("id", s);
        field_input.setAttribute("type", "text");


        s = "headerChange(" + i + ",this.value)";
        field_input.setAttribute("onchange", s);
        field.appendChild(field_input);

        header.appendChild(field);
      }

      document.getElementById("header").classList.toggle("hide", false);
      document.getElementById("next_page").classList.toggle("hide", false);
      document.getElementById("prev_page").classList.toggle("hide", false);
    }

    var FillHeader = function(page, npage, bfihed, hedlin) {
      if (db1 === undefined)
        return;

      // Fill header with data from data base
      var id, text;
      for (var i = 0; i < hedlin; i++) {
        id = "hedit" + i;
        if (page <= npage) {
          text = db1.GetValue(page, 0, bfihed[i]);
          document.getElementById(id).value = text;
        } else
          document.getElementById(id).value = "";
      }
      document.getElementById("pagecount").innerText = "Page " + page + " of " + npage;
    }

    var headerChange = function(fx, val) {
      db1.PutValue(val, view.curpag, 0, view.bfihed[fx]);
    }

    var detailChange = function(props, val) {
      db1.PutValue(val, view.curpag, props.line, props.bfi);
    }

    var BuildDetail = function(bfi, attr) {
      // TODO - set the column styles here
    }

    // React fires a change event for each keystroke.
    // This code duplicates the default behavior of only firing a change
    // event when the input field was changed and loses focus.
    class CellInput extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          changed: false
        };
      }

      // The cell value has changed
      onChange(event) {
        this.setState({
          changed: true
        });
      }

      // Blur the input field if the 'Enter' key is pressed
      onKeyPress(event) {
        if (event.which === 13) {
          event.target.blur();
        }
        return false;
      }

      // The cell lost focus; i.e. was blurred
      onBlur(event) {
        if (this.state.changed) {
          this.props.cellChange(this.props, event.target.value);
          this.setState({
            changed: false
          });
        }
      }

      render() {
        return React.createElement('input', {
          id: this.props.id,
          className: this.props.className,
          style: this.props.style,
          type: this.props.type,
          defaultValue: this.props.defaultValue,
          onChange: this.onChange.bind(this),
          onKeyPress: this.onKeyPress.bind(this),
          onBlur: this.onBlur.bind(this),
        });
      }
    }

    var myCellRenderer = function(parms) {
      if (db1 === undefined)
        return;
      return React.createElement(CellInput, {
        className: ((parms.rowIndex % 2) === 0) ? "evenCell" : "oddCell",
        style: parms.style,
        key: view.curpag + "," + (parms.rowIndex + 1) + "," + (parms.columnIndex + 1),
        type: "text",
        defaultValue: db1.GetValue(view.curpag, parms.rowIndex + 1, view.bficol[parms.columnIndex]),
        cellChange: detailChange,
        line: parms.rowIndex + 1,
        bfi: view.bficol[parms.columnIndex]
      });
    }

    // Cause the grid's current input cell to lose focus when scrolling.
    // This allows any changes to be saved.
    var handleGridScroll = function(parms) {
      document.activeElement.blur();
    }

    // Display the columnar portion of the edit screen
    var FillColumns = function(page, npage, bficol, collin) {
      var gridElement = /* add headers here with more React.createElement calls */ React.createElement(ReactVirtualized.AutoSizer, null, function(params) {
        return React.createElement(ReactVirtualized.Grid, {
          className: "detail_grid",
          cellRenderer: myCellRenderer,
          rowCount: db1.LineCount(page),
          rowHeight: 30,
          columnCount: view.collin,
          columnWidth: 300,
          height: params.height,
          width: params.width,
          onScroll: handleGridScroll,
          scrollToRow: 0,
          scrollToColumn: 0
        });
      });
      ReactDOM.render(gridElement, document.getElementById('detail'));
    }

    // Show or Hide the edit menu
    var toggleMenu = function() {
      document.getElementById("dropdown-content").classList.toggle("hide");
    }

    // Next page
    var leftArrowClick = function() {
      if (--view.curpag < 1) {
        view.curpag = 1;
        return;
      }
      FillHeader(view.curpag, view.npage, view.bfihed, view.hedlin);

      if (view.collin)
        FillColumns(view.curpag, view.npage, view.bficol, view.collin);
      //return false;
    }

    // Previous page
    var rightArrowClick = function() {
      ++view.curpag;
      if (view.curpag > view.npage) {
        // TODO logic for new pages
        alert("New Page");
        view.curpag = view.npage + 1;
      }
      FillHeader(view.curpag, view.npage, view.bfihed, view.hedlin);

      if (view.collin)
        FillColumns(view.curpag, view.npage, view.bficol, view.collin);
      //return false;
    }

    var trashClick = function() {
      alert("Trash not yet implemented");
    }

    var searchClick = function() {
      alert("Search not yet implemented");
    }

    var doReport = function() {
      document.getElementById("dropdown-content").classList.toggle("hide", true);
      db1.XMLReport(editScreen[currentScreen - 1].name);
    }

    var doExport = function() {
      document.getElementById("dropdown-content").classList.toggle("hide", true);
      db1.WriteCsvFile("output.csv", ',');
    }
  </script>
</body>

</html>
