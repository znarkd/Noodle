<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Noodle</title>
  <meta name="description" content="Noodle database editor." />
  <meta name="keywords" content="ARMR, Noodle, data, database" />
  <meta name="author" content="Dan Kranz" />
  <link rel="icon" type="image/png" href="favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png" />
  <link rel="stylesheet" href="libs/node_modules/normalize.css/normalize.css" type="text/css" />
  <link rel="stylesheet" href="libs/node_modules/font-awesome/css/font-awesome.min.css" />
  <script src="libs/node_modules/react/umd/react.production.min.js"></script>
  <script src="libs/node_modules/react-dom/umd/react-dom.production.min.js"></script>
  <script src="libs/node_modules/react-virtualized/dist/umd/react-virtualized.js"></script>
  <script src="libs/node_modules/react-draggable/dist/react-draggable.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="libs/Roots.js"></script>
  <script src="libs/Noodle.js"></script>
  <script src="libs/RootsIO.js"></script>
  <script src="libs/NoodleDatabase.js"></script>

  <style>
    html,
    body {
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      position: fixed;
      scroll-behavior: smooth;
      /* font-family: Verdana,sans-serif; */
    }

    .hide {
      display: none !important
    }

    .group {
      white-space: nowrap;
      display: inline-block;
    }

    .highlight {
      color: white;
      background: #0085ff;
    }

    .app {
      height: 100%;
      width: 100%;
    }

    .open-screen {
      display: grid;
      grid-template-columns: auto;
      background: #282c34;
      background: var(--background-color);
    }

    .close-open1 {
      grid-row: 1;
      text-align: center;
    }

    .close-open2 {
      display: inline-block;
      height: 40px;
    }

    @media screen and (min-width: 600px) {
      .close-open2 {
        width: 600px;
      }
    }

    @media screen and (max-width: 600px) {
      .close-open2 {
        width: 100%;
      }
    }

    .close-button {
      padding-right: 10px;
      padding-bottom: 10px;
      float: right;
      color: #aaaaaa;
      font-size: 28px;
      font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .open__icons {
      grid-row: 2;
      display: flex;
      justify-content: center;
      padding-top: 10px;
      align-items: stretch;
      flex-direction: row;
      flex-shrink: 0;
      flex-wrap: wrap
    }

    .open--drag .open__icons {
      display: none
    }

    .open__icon {
      text-align: center;
      cursor: pointer;
      margin: 20px;
      transition: color .15s ease
    }

    .open__icon:hover {
      color: #abb2bf;
      color: var(--medium-color)
    }

    .open__icon-i,
    .open__icon-svg {
      font-size: 4em
    }

    .open__icon-text {
      color: #4f545e;
      color: var(--muted-color)
    }

    .open__icon:hover>.open__icon-text {
      color: #abb2bf;
      color: var(--medium-color)
    }

    .open__icon-svg {
      line-height: 0
    }

    .open__icon-svg>svg {
      height: 1em;
      width: 1em
    }

    .navbar {
      width: 100%;
      height: 41px;
      white-space: nowrap;
      color: #f1f1f1;
      background-color: #5f5f5f;
      overflow: hidden;
    }

    .navbar a {
      float: left;
      font-size: 1.5em;
      color: white;
      text-align: center;
      padding: 7px 20px;
      text-decoration: none;
    }

    #pagecount,
    #screentitle {
      float: left;
      font-size: 1.25em;
      color: white;
      background-color: #5f5f5f;
      text-align: center;
      padding: 7px 20px;
      border-style: none;
    }

    .dropdown {
      float: left;
    }

    .dropdown .dropbtn {
      font-size: 1.5em;
      border: none;
      outline: none;
      color: white;
      padding: 7px 20px;
      background-color: inherit;
      font-family: inherit;
      margin: 0;
    }

    .navbar a:hover,
    .dropdown:hover .dropbtn {
      background-color: #990000;
      cursor: pointer;
    }

    .dropdown-content {
      display: block;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 190px;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 1;
      overflow-y: auto;
      max-height: 80%;
    }

    .dropdown-content h2 {
      float: none;
      color: black;
      text-decoration: none;
      display: block;
      text-align: left;
      font-size: 1.25em;
      padding: 20px 2px 2px 10px;
      margin: -4px 0 4px 0;
    }

    .dropdown-content a {
      float: none;
      color: black;
      text-decoration: none;
      display: block;
      text-align: left;
      font-size: 1em;
      padding: 3px 2px 3px 18px;
    }

    .dropdown-content a:hover {
      background-color: #ddd;
    }

    #menuFile {
      padding: 6px 2px 2px 10px;
    }

    #menuSave {
      border-bottom: 1px solid black;
    }

    #menuXML,
    #menuDeleteScreen {
      padding-top: 10px;
    }

    .right-nav {
      float: right;
    }

    .edit-display {
      top: 41px;
      position: fixed;
      width: 100%;
      height: calc(100% - 41px);
      background-color: lightgray;
    }

    .header {
      max-height: 100px;
      width: 100%;
      padding-top: 6px;
      background-color: lightgray;
      display: flex;
      flex-wrap: wrap;
      white-space: normal;
      overflow: auto;
    }

    .header_field {
      margin-left: 14px;
      padding-right: 4px;
      white-space: nowrap;
      font-weight: normal;
      color: darkblue;
    }

    .header_field input {
      margin-right: 4px;
      margin-bottom: 4px;
      color: black;
    }

    .detail {
      background-color: lightgray;
      width: auto;
      height: calc(100% - 120px);
      padding-left: 2px;
      padding-right: 2px;
    }

    .detail_grid {
      border-top: 2px solid white;
      border-bottom: 2px solid white;
      background-color: lightgray;
    }

    .labelCell {
      display: flex;
      align-items: center;
      border: 2px solid #949494;
      background-color: lightgray;
    }

    .labelText {
      margin: auto;
      position: relative;
      display: flex;
      text-align: center;
      overflow: hidden;
    }

    .evenCell,
    .oddCell {
      display: flex;
      align-items: center;
      border-right: 1px solid #d9dddd;
      border-bottom: 1px solid #d9dddd;
    }

    .evenCell {
      background-color: #f4f4f4;
    }

    .oddCell {
      background-color: white;
    }

    #fileInput {
      display: none;
    }

    .DragHandle {
      flex: 0 0 4px;
      z-index: 2;
      cursor: col-resize;
      color: #0085ff;
    }

    .DragHandle:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }

    .DragHandleActive,
    .DragHandleActive:hover {
      color: #0b6fcc;
      z-index: 3;
    }

    .column-sizer {
      width: 1px;
      height: 100%;
      cursor: col-resize;
      transform: translate(0px, 0px) !important;
    }

    /* The modal screen builder */

    #build-screen {
      display: block;
      position: fixed;
      z-index: 1;
      padding-top: 10px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }

    .item1 {
      grid-area: header;
    }

    .item2 {
      grid-area: lists;
    }

    .item4 {
      grid-area: attr;
    }

    .item5 {
      grid-area: footer;
      text-align: center;
    }

    #build-screen-form {
      display: -ms-grid;
      display: grid;
      grid-template-areas: "header header" "lists attr" "footer footer";
      grid-gap: 0px;
      background-color: gray;
      margin: auto;
      border: 2px solid black;
    }

    @media screen and (min-width: 600px) {
      #build-screen-form {
        width: 600px;
      }
    }

    #buildform1 {
      padding-bottom: 20px;
    }

    #build-screen-form>div {
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px;
      font-size: 1.25em;
    }

    .field_list {
      border: 2px solid dimgray;
      background-color: white;
      padding: 2px;
      height: 120px;
      overflow: auto;
    }

    .allfields {
      position: absolute;
      z-index: 2;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
      height: 120px;
    }

    .dbfields {
      position: relative;
      height: 120px;
      width: 120px;
      border: 2px solid dimgray;
      background-color: white;
      overflow: auto;
    }

    @media screen and (max-height: 800px) {
      .field_list,
      .allfields,
      .dbfields {
        height: 80px;
      }
    }

    .field_name {
      padding: 1px;
      cursor: pointer;
    }

    #screen-header-selected .field_name:hover {
      border: 1px solid white;
    }

    #screen-detail-selected .field_name:hover {
      border: 1px solid white;
    }

    .dbfields .field_name:hover {
      background-color: #ddd;
    }

    #field-width {
      width: 80px;
    }

    #move-field {
      padding-top: 20px;
      padding-left: 20px;
    }

    .item5>button {
      width: 100px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div id="open-screen" class="open-screen">
      <div id="close-open1" class="close-open1">
        <div id="close-open2" class="close-open2">
          <div id="close-button" class="close-button hide">&times;</div>
        </div>
      </div>
      <div class="open__icons">
        <div id="fileIcon" class="open__icon open__icon-open">
          <i class="fa fa-lock open__icon-i"></i>
          <div class="open__icon-text">Open</div>
          <input type="file" id="fileInput" accept=".csv,.ndl" />
        </div>
        <div class="open__icon open__icon-new">
          <i class="fa fa-plus open__icon-i"></i>
          <div class="open__icon-text">New</div>
        </div>
        <div id="demo" class="open__icon open__icon-demo">
          <i class="fa fa-magic open__icon-i"></i>
          <div class="open__icon-text">Demo</div>
        </div>
        <div id="gdrive" class="open__icon open__icon-storage svg-btn" data-storage="gdrive">
          <div class="open__icon-svg"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128">
              <path d="M86.657536,76.246208 L47.768064,9 L89.111168,9 L128,76.246208 L86.657536,76.246208 Z M25.010048,119.08 L102.690048,119.08 L123.36256,83.24 L45.68064,83.24 L25.010048,119.08 L25.010048,119.08 Z M38.793088,9.003712 L0,76.30496 L20.671872,112.110016 L59.464704,44.808128 L38.793088,9.003712 Z"></path>
            </svg></div>
          <div class="open__icon-text">Google Drive</div>
        </div>
        <div class="open__icon open__icon-more">
          <i class="fa fa-ellipsis-h open__icon-i"></i>
          <div class="open__icon-text">More</div>
        </div>
      </div>
    </div>
    <div id="build-screen" class="hide">
      <div id="build-screen-form">
        <div class="item1">
          <div id="buildform1">Identify Header and Detail fields to denote layout sequence</div>
          <label>Screen Name:</label>
          <input id="screen-name" type="text" size="40" />
        </div>
        <div class="item2">
          <div>
            <p>
              <label>Screen Header</label> &nbsp;
              <span class="group">
                <button id="addheader" title="Add header field">
                  <i class="fa fa-plus" aria-hidden="true"></i>
                </button>
                <button id="deleteheader" title="Remove selected header field">
                  <i class="fa fa-minus" aria-hidden="true"></i>
                </button>
              </span>
            </p>
            <div id="screen-header" class="field_list">
              <div id="allfields-header" class="allfields hide">
                <div id="dbfields-header" class="dbfields">
                  <div class="field_name">f1</div>
                </div>
              </div>
              <div id="screen-header-selected">
                <div class="field_name">H1</div>
              </div>
            </div>
            <p>
              <br/>
              <label>Screen Detail</label> &nbsp;
              <span class="group">
                <button id="addcolumn" title="Add detail field">
                  <i class="fa fa-plus" aria-hidden="true"></i>
                </button>
                <button id="deletecolumn" title="Remove selected detail field">
                  <i class="fa fa-minus" aria-hidden="true"></i>
                </button>
              </span>
            </p>
            <div id="screen-detail" class="field_list">
              <div id="allfields-detail" class="allfields hide">
                <div id="dbfields-detail" class="dbfields">
                  <div class="field_name">f1</div>
                </div>
              </div>
              <div id="screen-detail-selected">
                <div class="field_name">C1</div>
              </div>
            </div>
          </div>
        </div>
        <div class="item4">
          <fieldset>
            <legend>Field Attributes</legend>
            <input type="checkbox" id="field-visible" value="visible" /> Visible<br>
            <input type="checkbox" id="field-protected" value="protected" /> Protected<br>
            <input type="checkbox" id="field-summary" value="summary" /> Summary<br>
            <input type="checkbox" id="field-autodate" value="autodate" /> Auto-Date<br>
            <input type="checkbox" id="field-hyperlink" value="hyperlink" /> Hyperlink
            <p>
              Display Width:
              <br/>
              <input type="number" id="field-width" size="4" maxlength="4" max="1200" />
            </p>
          </fieldset>
          <div id="move-field">
            Move Field<br/>
            <button id="moveup" title="Move selected field up">
              <i class="fa fa-arrow-up" aria-hidden="true" ></i>
            </button> &nbsp; &nbsp;
            <button id="movedown" title="Move selected field down">
              <i class="fa fa-arrow-down" aria-hidden="true"></i>
            </button>
          </div>
        </div>
        <div class="item5">
          <button id="savescreenchange">Save</button> &nbsp; &nbsp;
          <button id="cancelscreenchange">Cancel</button>
        </div>
      </div>
    </div>
    <div id="edit-screen" class="edit-screen hide">
      <div id="navbar" class="navbar">
        <div id="dropdown" class="dropdown">
          <button class="dropbtn"><i class="fa fa-bars"></i></button>
          <div id="dropdown-content" class="dropdown-content hide">
            <h2 id="menuFile">File</h2>
            <a id="menuopen">Open</a>
            <a id="menuSave">Save</a>
            <a id="menuXML">Export as XML</a>
            <a id="menuCSV">Export as CSV</a>
            <h2>Data</h2>
            <a>Prune</a>
            <a>Prune by Current Field</a>
            <a>Drop Current Field Value</a>
            <a>Invert Prune</a>
            <a>Remove Prune</a>
            <h2>Screen</h2>
            <a id="menuNewScreen">New Layout</a>
            <a id="menuReviseScreen" style="border-bottom: 1px solid black;">Revise Layout</a>
            <a id="menuDeleteScreen">Delete Layout</a>
          </div>
        </div>
        <a id="prev_page"><i class="fa fa-arrow-left"></i></a>
        <a id="next_page"><i class="fa fa-arrow-right"></i></a>
        <span id="pagecount">Page nnn of mmm</span>
        <select id="screentitle">
          <option value="1">A description of the screen contents</option>
        </select>
        <div class="right-nav">
          <a id="trash"><i class="fa fa-trash"></i></a>
          <a id="search"><i class="fa fa-search"></i></a>
        </div>
      </div>
      <div id="edit-display" class="edit-display">
        <div id="header" class="header">
        </div>
        <div id="detail" class="detail">
        </div>
      </div>
    </div>
  </div>

  <script type="application/javascript">
    // the Database
    var db1;

    // Screen layouts
    var editScreen = [];
    var currentScreen = 0;
    var SCREEN_GET = 1;
    var SCREEN_SORT = 2;

    // Data view - initialized in showEditScreen()
    var view = {};

    // for Grid hacks
    var refreshNum = 0;
    var lineCount = 0;

    // Set up app events

    window.onbeforeunload = function(event) {
      event.returnValue = "Are you sure you want to leave this page?";
    }

    window.onload = function() {
      document.getElementById("close-button").addEventListener("click", closeOpen);
      document.getElementById("fileIcon").addEventListener("click", function() {
        document.getElementById('fileInput').click();
      });
      document.getElementById("fileInput").addEventListener("click", function() {
        this.value = null;
      });
      document.getElementById("fileInput").addEventListener("change", function() {
        fileSelected(this.files);
      });
      document.getElementById("demo").addEventListener("click", showDemo);
      document.getElementById("gdrive").addEventListener("click", gdrive);
      document.getElementById("screen-name").addEventListener("change", ScreenNameChange);
      document.getElementById("addheader").addEventListener("click", addScreenHeader);
      document.getElementById("deleteheader").addEventListener("click", deleteScreenHeader);
      document.getElementById("addcolumn").addEventListener("click", addScreenCol);
      document.getElementById("deletecolumn").addEventListener("click", deleteScreenCol);
      document.getElementById("field-width").addEventListener("change", widthChange);
      document.getElementById("moveup").addEventListener("click", moveFieldUp);
      document.getElementById("movedown").addEventListener("click", moveFieldDown);
      document.getElementById("savescreenchange").addEventListener("click", SaveScreen);
      document.getElementById("cancelscreenchange").addEventListener("click", HideBuildScreen);
      document.getElementById("dropdown").addEventListener("click", dropdownClick);
      document.getElementById("menuopen").addEventListener("click", ShowOpen);
      document.getElementById("menuXML").addEventListener("click", doReport);
      document.getElementById("menuCSV").addEventListener("click", doExport);
      document.getElementById("menuNewScreen").addEventListener("click", function() {
        ShowBuildScreen(true);
      });
      document.getElementById("menuReviseScreen").addEventListener("click", function() {
        ShowBuildScreen(false);
      });
      document.getElementById("menuDeleteScreen").addEventListener("click", DeleteScreen);
      document.getElementById("prev_page").addEventListener("click", leftArrowClick);
      document.getElementById("next_page").addEventListener("click", rightArrowClick);
      document.getElementById("screentitle").addEventListener("change", screenChange);
      document.getElementById("trash").addEventListener("click", trashClick);
      document.getElementById("search").addEventListener("click", searchClick);
    }

    var showDemo = function() {

      // Prepare a large data set

      var zData = [];
      var i, d;
      var letters = [
        'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',
        'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'
      ];
      var noyes = ["No", "Yes"]

      for (i = 0; i < 20000; i++) {
        d = (zData[i] = {});
        d["Seq"] = i + 1;
        d["Char1"] = letters[Math.floor(Math.random() * 26)];
        d["YN"] = noyes[Math.floor(Math.random() * 2)];
        d["String3"] = letters[Math.floor(Math.random() * 26)] +
          letters[Math.floor(Math.random() * 26)] +
          letters[Math.floor(Math.random() * 26)];
        d["RNum"] = Math.random() * 10000;
        d["Num"] = Math.floor((Math.random() * 100) + 1);
        d["Date"] = Date.now();
        d["Count"] = 1;
      }

      db1 = new Noodle(zData);

      // Create a sample edit screen for the demo

      editScreen[0] = {
        "name": "Rows by Char1 and YN",
        "header": [{
            "field": "Char1"
          },
          {
            "field": "YN",
            "width": 40
          },
          {
            "field": "Count",
            "width": 100
          },
          {
            "field": "Count",
            "width": 100
          },
          {
            "field": "Count",
            "width": 100
          },
          {
            "field": "Count",
            "width": 100
          }
        ],
        "columns": [{
            "field": "String3",
            "width": 80
          },
          {
            "field": "Seq",
            "width": 80
          },
          {
            "field": "RNum",
            "width": 250
          },
          {
            "field": "Date",
            "width": 250
          }
        ]
      };
      editScreen[1] = {
        "name": "Char1 values by YN",
        "header": [{
          "field": "YN",
          "width": 80
        }],
        "columns": [{
          "field": "Char1",
          "width": 80
        }]
      };
      editScreen[2] = {
        "name": "All header",
        "header": [{
            "field": "Char1"
          },
          {
            "field": "String3"
          }
        ]
      };
      editScreen[3] = {
        "name": "No header",
        "columns": [{
            "field": "String3"
          },
          {
            "field": "Char1"
          }
        ]
      };

      // Show the screen of data
      showEditScreen();
    }

    var dropdownClick = function() {
      document.getElementById("dropdown-content").classList.toggle("hide");
    }

    // Show the open screen
    var ShowOpen = function() {
      document.getElementById("edit-screen").classList.toggle("hide", true);
      document.getElementById("close-button").classList.toggle("hide", false);
      document.getElementById("open-screen").style.display = "block";
    }

    var closeOpen = function() {
      document.getElementById("open-screen").style.display = "none";
      document.getElementById("edit-screen").classList.toggle("hide", false);
    }

    var _escreen;
    var _newscreen;
    var _build_screen_selected_id;

    var copyScreen = function(scr) {
      return JSON.parse(JSON.stringify(scr));
    }

    var updateScreenHeader = function() {
      var i, element, field;
      element = document.getElementById("screen-header-selected");
      RemoveChildElements("screen-header-selected");
      if (_escreen.header != undefined) {
        for (i = 0; i < _escreen.header.length; i++) {
          field = document.createElement("div");
          field.setAttribute("id", "hed" + i);
          field.className = "field_name";
          field.onclick = function() {
            build_screen_field_click(this.id);
          };
          field.innerText = _escreen.header[i].field;
          element.appendChild(field);
        }
      }
    }

    var updateScreenDetail = function() {
      var i, element, field;
      element = document.getElementById("screen-detail-selected");
      RemoveChildElements("screen-detail-selected");
      if (_escreen.columns != undefined) {
        for (i = 0; i < _escreen.columns.length; i++) {
          field = document.createElement("div");
          field.setAttribute("id", "col" + i);
          field.className = "field_name";
          field.onclick = function() {
            build_screen_field_click(this.id);
          };
          field.innerText = _escreen.columns[i].field;
          element.appendChild(field);
        }
      }
    }

    var addScreenHeader = function() {
      document.getElementById("allfields-header").classList.toggle("hide");
    }

    var newHeaderSelected = function(fieldname) {
      var o = {};
      o.field = fieldname;
      if (_escreen.header === undefined)
        _escreen.header = [];
      _escreen.header.push(o);
      document.getElementById("allfields-header").classList.toggle("hide", true);
      updateScreenHeader();
      _build_screen_selected_id = undefined;
    }

    var deleteScreenHeader = function() {
      if (_build_screen_selected_id === undefined)
        return;
      if (_build_screen_selected_id.startsWith("hed")) {
        var index = parseInt(_build_screen_selected_id.substring(3));
        _escreen.header.splice(index, 1);
        updateScreenHeader();
        _build_screen_selected_id = undefined;
      }
    }

    var addScreenCol = function() {
      document.getElementById("allfields-detail").classList.toggle("hide");
    }

    var newColumnSelected = function(fieldname) {
      var o = {};
      o.field = fieldname;
      if (_escreen.columns === undefined)
        _escreen.columns = [];
      _escreen.columns.push(o);
      document.getElementById("allfields-detail").classList.toggle("hide", true);
      updateScreenDetail();
      _build_screen_selected_id = undefined;
    }

    var deleteScreenCol = function() {
      if (_build_screen_selected_id === undefined)
        return;
      if (_build_screen_selected_id.startsWith("col")) {
        var index = parseInt(_build_screen_selected_id.substring(3));
        _escreen.columns.splice(index, 1);
        updateScreenDetail();
        _build_screen_selected_id = undefined;
      }
    }

    var moveFieldUp = function() {
      if (_build_screen_selected_id === undefined)
        return;
      var index = parseInt(_build_screen_selected_id.substring(3));
      if (index === 0)
        return;
      if (_build_screen_selected_id.startsWith("hed")) {
        [_escreen.header[index - 1], _escreen.header[index]] = [_escreen.header[index], _escreen.header[index - 1]];
        updateScreenHeader();
        _build_screen_selected_id = undefined;
        build_screen_field_click("hed" + (index - 1));
      } else {
        [_escreen.columns[index - 1], _escreen.columns[index]] = [_escreen.columns[index], _escreen.columns[index - 1]];
        updateScreenDetail();
        _build_screen_selected_id = undefined;
        build_screen_field_click("col" + (index - 1));
      }
    }

    var moveFieldDown = function() {
      if (_build_screen_selected_id === undefined)
        return;
      var index = parseInt(_build_screen_selected_id.substring(3));
      if (_build_screen_selected_id.startsWith("hed")) {
        if (index + 1 >= _escreen.header.length)
          return;
        [_escreen.header[index], _escreen.header[index + 1]] = [_escreen.header[index + 1], _escreen.header[index]];
        updateScreenHeader();
        _build_screen_selected_id = undefined;
        build_screen_field_click("hed" + (index + 1));
      } else {
        if (index + 1 >= _escreen.columns.length)
          return;
        [_escreen.columns[index], _escreen.columns[index + 1]] = [_escreen.columns[index + 1], _escreen.columns[index]];
        updateScreenDetail();
        _build_screen_selected_id = undefined;
        build_screen_field_click("col" + (index + 1));
      }
    }

    var ScreenNameChange = function(event) {
      _escreen.name = event.target.value;
    }

    var widthChange = function(event) {
      if (_build_screen_selected_id === undefined)
        return false;
      var val = parseInt(event.target.value);
      if (isNaN(val))
        return false;

      var i = parseInt(_build_screen_selected_id.substring(3));
      if (_build_screen_selected_id.startsWith("hed"))
        _escreen.header[i].width = val;
      else
        _escreen.columns[i].width = val;
      return true;
    }

    var build_screen_field_click = function(id) {
      if (_build_screen_selected_id != undefined)
        document.getElementById(_build_screen_selected_id).classList.toggle("highlight", false);
      document.getElementById(id).classList.toggle("highlight", true);
      _build_screen_selected_id = id;

      var i = parseInt(_build_screen_selected_id.substring(3));
      var val;
      if (_build_screen_selected_id.startsWith("hed"))
        val = _escreen.header[i].width;
      else
        val = _escreen.columns[i].width;
      if (val === undefined)
        val = "";
      document.getElementById("field-width").value = val;
      return true;
    }

    // Show the build screen dialog
    var ShowBuildScreen = function(newscreen) {
      if (newscreen) {
        _escreen = {};
        _escreen.name = "New Screen";
        _escreen.header = [];
        _escreen.columns = [];
      } else
        _escreen = copyScreen(editScreen[currentScreen - 1]);
      _newscreen = newscreen;

      document.getElementById("build-screen").classList.toggle("hide", false);

      var element = document.getElementById("screen-name");
      element.value = _escreen.name;
      updateScreenHeader();
      updateScreenDetail();
    }

    // Delete the screen which is currently selected
    var DeleteScreen = function() {
      if (!confirm("Delete layout: " + editScreen[currentScreen-1].name + "?"))
        return;

      RemoveChildElements("screentitle");
      editScreen.splice(currentScreen - 1, 1);

      if (editScreen.length === 0)
        ShowBuildScreen(true);

      ScreenGet();
      if (currentScreen > editScreen.length)
        currentScreen = editScreen.length;

      document.getElementById("screentitle").selectedIndex = currentScreen - 1;
      screenChange();
    }

    // Save user changes to the screen
    var SaveScreen = function() {
      if (_newscreen) {
        editScreen.push(_escreen);
        currentScreen = editScreen.length;
      } else
        editScreen[currentScreen - 1] = copyScreen(_escreen);
      RemoveChildElements("screentitle");
      ScreenGet();
      document.getElementById("screentitle").selectedIndex = currentScreen - 1;
      screenChange();
      document.getElementById("build-screen").classList.toggle("hide", true);
      _build_screen_selected_id = undefined;
    }

    // The user canceled build screen changes
    var HideBuildScreen = function() {
      document.getElementById("build-screen").classList.toggle("hide", true);
      _build_screen_selected_id = undefined;
    }

    // Read a file from Google Drive

    var gdrive = function() {
      Roots.GDriveGetFile(onGDriveFileLoaded);
    }
    var onGDriveFileLoaded = function(stream) {
      try {
        var ary = new NoodleDatabase(stream);
        db1 = new Noodle(ary);
        editScreen = ary.getScreens();
        showEditScreen();
      } catch (err) {
        alert(err);
      }
    }

    // Read a file from the local file system

    var _filetype;
    var fileSelected = function(files) {
      var file = files[0];
      if (file) {
        _filetype = file.name.substring(file.name.lastIndexOf('.') + 1, file.name.length) || file.name;
        Roots.GetLocalFile(file, fileLoaded);
      }
    }
    var fileLoaded = function(text) {
      if (_filetype === "ndl") {
        try {
          var ary = new NoodleDatabase(text);
          db1 = new Noodle(ary);
          editScreen = ary.getScreens();
          showEditScreen();
        } catch (err) {
          alert(err);
        }
      } else if (_filetype === "csv") {
        try {
          var sep = Roots.initCSV(text);
          var data = Roots.parseCSV(text, sep);

          // Assume the 1st row contains the column labels
          var labels = data.shift();

          db1 = new Noodle(data, labels);

          // Build a sample edit screen
          var nf = db1.FieldCount();
          editScreen = [];
          editScreen[0] = {};
          editScreen[0].name = "sample";
          editScreen[0].columns = [];
          for (var i = 0; i < nf; i++) {
            editScreen[0].columns[i] = {};
            editScreen[0].columns[i].field = db1.FieldName(i + 1);
          }
          showEditScreen();
        } catch (err) {
          alert(err);
        }
      } else alert("Unsupported filetype");
    }

    var ScreenGet = function() {
      //if (db1.GetEditScreens != undefined)
      //  editScreen = db1.GetEditScreens();

      // Build a menu of screens
      var sel = document.getElementById("screentitle");
      var fragment = document.createDocumentFragment();

      editScreen.forEach(function(scr, index) {
        var opt = document.createElement("option");
        opt.text = scr.name;
        opt.value = index;
        fragment.appendChild(opt);
      });

      sel.appendChild(fragment);
    }

    var screenChange = function() {
      currentScreen = parseInt(document.getElementById("screentitle").value) + 1;
      if (isNaN(currentScreen))
        currentScreen = 0;

      // Initialize the data view
      view.hedlin = 0;
      view.bfihed = [];
      view.collin = 0;
      view.bficol = [];
      view.npage = 0;
      view.curpag = 0;

      // Display the new screen of data
      ShowNewScreen(SCREEN_SORT);
    }

    var showEditScreen = function() {
      if (db1 === undefined)
        return;

      // Hide non-edit screens
      document.getElementById("open-screen").style.display = "none";

      // Initialize the screen menu
      RemoveChildElements("screentitle");

      // Initialize the data view
      view.hedlin = 0;
      view.bfihed = [];
      view.collin = 0;
      view.bficol = [];
      view.npage = 0;
      view.curpag = 0;

      var i, n, sel, fragment, elem;

      // Build a field list for the screen header
      sel = document.getElementById("dbfields-header");
      RemoveChildElements("dbfields-header");
      fragment = document.createDocumentFragment();
      n = db1.FieldCount();
      for (i = 0; i < n; i++) {
        elem = document.createElement("div");
        elem.innerText = db1.FieldName(i + 1);
        elem.className = "field_name";
        elem.onclick = function() {
          newHeaderSelected(this.innerText);
        };
        fragment.appendChild(elem);
      }
      sel.appendChild(fragment);

      // and a field list for the screen detail
      sel = document.getElementById("dbfields-detail");
      RemoveChildElements("dbfields-detail");
      fragment = document.createDocumentFragment();
      n = db1.FieldCount();
      for (i = 0; i < n; i++) {
        elem = document.createElement("div");
        elem.innerText = db1.FieldName(i + 1);
        elem.className = "field_name";
        elem.onclick = function() {
          newColumnSelected(this.innerText);
        };
        fragment.appendChild(elem);
      }
      sel.appendChild(fragment);

      // Show the first screen
      currentScreen = 1;
      ShowNewScreen(SCREEN_GET | SCREEN_SORT);
    }

    var coslay = function() {
      var i;

      if (currentScreen < 1)
        return false;

      // Extract header fields
      if (editScreen[currentScreen - 1].header != undefined)
        view.hedlin = editScreen[currentScreen - 1].header.length;
      else
        view.hedlin = 0;
      for (i = 0; i < view.hedlin; i++) {
        view.bfihed[i] = db1.BFI(editScreen[currentScreen - 1].header[i].field);
      }

      // Extract columnar fields
      if (editScreen[currentScreen - 1].columns != undefined)
        view.collin = editScreen[currentScreen - 1].columns.length;
      else
        view.collin = 0;
      for (i = 0; i < view.collin; i++) {
        view.bficol[i] = db1.BFI(editScreen[currentScreen - 1].columns[i].field);
      }

      return true;
    }

    var BuildView = function() {
      var i;

      // Translate the screen file
      if (!coslay())
        return false;

      // Set the data base view
      db1.InitializeView();
      for (i = 0; i < view.hedlin; i++) {
        //if (screen.layout->hAttribute[i].style & ATTR_SUMMARY)
        //	db1.EnterHeaderSum(view.bfihed[i]);
        //else
        db1.EnterHeader(view.bfihed[i]);
      }
      for (i = 0; i < view.collin; i++) {
        //if (screen.layout->cAttribute[i].style & ATTR_SUMMARY)
        //	db1.EnterColumnarSum(view.bficol[i]);
        //else
        db1.EnterColumnar(view.bficol[i]);
      }
      db1.GenerateView();

      view.npage = db1.PageCount();
      view.curpag = 1;
      //view.lineCount = db1.LineCount(1);
      return true;
    }

    var BuildForm = function() {
      BuildHeader(view.bfihed, 0);
      BuildDetail(view.bficol, 0);
    }

    var FillPage = function() {

      //	Fill the header portion
      if (view.hedlin)
        FillHeader(view.curpag, view.npage, view.bfihed, view.hedlin);

      //	Fill the columnar portion
      if (view.collin)
        FillColumns(view.curpag, view.npage, view.bficol, view.collin, false);
    }

    var RemoveChildElements = function(name) {
      var sel = document.getElementById(name);
      while (sel.firstChild !== null) {
        child = sel.firstChild;
        sel.removeChild(child);
      }
    }

    var ShowNewScreen = function(nFlags) {
      // Get the currently selected screen to display
      if (nFlags & SCREEN_GET)
        ScreenGet();

      // Sort the data based on the screen layout
      if (nFlags & SCREEN_SORT)
        BuildView();

      // Create a form for displaying the data view and display the first page of data.
      BuildForm();

      document.getElementById("edit-screen").classList.toggle("hide", false);

      // Load data into the newly created screen page
      FillPage();
    }

    var headerChange = function(fx, val) {
      // Ignore changes to Protected or Summary field

      // Add a new page?
      if (view.curpag > view.npage) {
        db1.CreateNewPage();
        view.npage++;
        document.getElementById("pagecount").innerText = "Page " + view.curpag + " of " + view.npage;
      }

      // Save the value to the database
      db1.PutValue(val, view.curpag, 0, view.bfihed[fx]);
    }

    var detailChange = function(props, val) {
      if (props.bfi === undefined)
        return;
      var refresh = false;
      var n = db1.LineCount(view.curpag);
      if (props.line > n) {
        db1.CreateNewLineOnPage(view.curpag);
        refresh = true;
      }
      db1.PutValue(val, view.curpag, props.line, props.bfi);
      if (refresh)
        FillColumns(view.curpag, view.npage, view.bficol, view.collin, true);
    }

    var BuildHeader = function(bfi, attr) {
      var i, s, field, field_input, nline = bfi.length;
      var header = document.getElementById("header");
      var detail = document.getElementById("detail");
      var child;

      // Delete old header input fields
      RemoveChildElements("header");

      // Hide the header when there are no header input fields
      if (nline === 0) {
        document.getElementById("header").classList.toggle("hide", true);
        document.getElementById("next_page").classList.toggle("hide", true);
        document.getElementById("prev_page").classList.toggle("hide", true);
        document.getElementById("pagecount").classList.toggle("hide", true);
        return;
      }

      // Build the new header input fields
      for (i = 0; i < nline; i++) {
        field = document.createElement("span");
        field.className = "header_field";
        field.innerText = db1.FieldName(bfi[i]) + " ";
        field_input = document.createElement("input");
        field_input.setAttribute("id", "hedit" + i);
        field_input.setAttribute("type", "text");

        var w = editScreen[currentScreen - 1].header[i].width;
        if (w != undefined)
          field_input.setAttribute("style", "width: " + w + "px;");

        s = "headerChange(" + i + ",this.value);";
        field_input.setAttribute("onchange", s);
        field.appendChild(field_input);

        header.appendChild(field);
      }

      document.getElementById("header").classList.toggle("hide", false);
      document.getElementById("next_page").classList.toggle("hide", false);
      document.getElementById("prev_page").classList.toggle("hide", false);
      document.getElementById("pagecount").classList.toggle("hide", false);
    }

    var FillHeader = function(page, npage, bfihed, hedlin) {
      if (db1 === undefined)
        return;

      // Fill header with data from data base
      var id, text;
      for (var i = 0; i < hedlin; i++) {
        id = "hedit" + i;
        if (page <= npage) {
          text = db1.GetValue(page, 0, bfihed[i]);
          document.getElementById(id).value = text;
        } else
          document.getElementById(id).value = "";
      }
      document.getElementById("pagecount").innerText = "Page " + page + " of " + npage;
    }

    // Get the width of grid columns
    var getColumnWidth = function(parms) {
      if (parms.index === 0 || parms.index > view.collin)
        return 60;
      var w = editScreen[currentScreen - 1].columns[parms.index - 1].width;
      if (w === undefined)
        w = 300;
      return w;
    }

    var BuildDetail = function(bfi, attr) {
      var nline = bfi.length;
      if (nline === 0) {
        document.getElementById("detail").classList.toggle("hide", true);
        return;
      }

      // TODO - set the column styles here

      document.getElementById("detail").classList.toggle("hide", false);
    }

    // React fires a change event for each keystroke.
    // This code duplicates the default behavior of only firing a change
    // event when the input field was changed and loses focus.
    class CellInput extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          changed: false
        };
      }

      // The cell value has changed
      onChange(event) {
        this.setState({
          changed: true
        });
      }

      // Blur the input field if the 'Enter' key is pressed
      onKeyPress(event) {
        if (event.which === 13) {
          event.target.blur();
        }
        return false;
      }

      // The cell lost focus; i.e. was blurred
      onBlur(event) {
        if (this.state.changed) {
          if (this.props.bfi === undefined)
            event.target.value = this.props.defaultValue;
          else
            this.props.cellChange(this.props, event.target.value);
          this.setState({
            changed: false
          });
        }
      }

      render() {
        return React.createElement("input", {
          id: this.props.id,
          className: this.props.className,
          style: this.props.style,
          type: this.props.type,
          defaultValue: this.props.defaultValue,
          onChange: this.onChange.bind(this),
          onKeyPress: this.onKeyPress.bind(this),
          onBlur: this.onBlur.bind(this)
        });
      }
    }

    var resizeRow = function(parms) {
      if (parms.index === 0)
        return;
      if (parms.index > editScreen[currentScreen - 1].columns.length)
        return;
      var w = getColumnWidth(parms);
      w += parms.deltaX;
      if (w < 10)
        w = 10;
      editScreen[currentScreen - 1].columns[parms.index - 1].width = w;
      grid.recomputeGridSize({
        columnIndex: 0,
        rowIndex: 0
      });
    }

    var myCellRenderer = function(parms) {
      if (db1 === undefined)
        return;

      var value;

      if (parms.rowIndex === 0) {
        if (parms.columnIndex === 0)
          value = "+";
        else if (parms.columnIndex > view.collin)
          value = "*";
        else
          value = db1.FieldName(view.bficol[parms.columnIndex - 1]);
        return React.createElement('div', {
            className: "labelCell",
            style: parms.style,
            key: 'L' + refreshNum + ',' + parms.rowIndex + ',' + parms.columnIndex
          }, React.createElement('div', {
            className: "labelText"
          }, value),
          React.createElement(window.ReactDraggable, {
            axis: "x",
            defaultClassName: "DragHandle",
            defaultClassNameDragging: "DragHandleActive",
            onDrag: function onDrag(event, _ref2) {
              var deltaX = _ref2.deltaX;
              return resizeRow({
                index: parms.columnIndex,
                deltaX: deltaX
              });
            },
            position: {
              x: 0
            },
            zIndex: 999
          }, React.createElement("div", {
            className: "column-sizer",
            style: {
              backgroundColor: "lightgray",
              borderTop: "2px solid #949494",
              borderRight: "2px solid #949494",
              borderBottom: "2px solid #949494"
            }
          }))
        );
      }

      if (parms.columnIndex === 0) {
        value = "" + parms.rowIndex;
        return React.createElement('div', {
          className: "labelCell",
          style: parms.style,
          key: 'L' + refreshNum + ',' + parms.rowIndex + ',' + parms.columnIndex
        }, React.createElement('div', {
          className: "labelText"
        }, value));
      }

      if (parms.rowIndex > lineCount)
        value = "";
      else if (parms.columnIndex > view.collin) {
        value = db1.RecordCount(view.curpag, parms.rowIndex);
        if (value === 1)
          value = "";
      } else
        value = db1.GetValue(view.curpag, parms.rowIndex, view.bficol[parms.columnIndex - 1]);
      return React.createElement(CellInput, {
        className: ((parms.rowIndex % 2) === 0) ? "evenCell" : "oddCell",
        style: parms.style,
        key: 'K' + refreshNum + ',' + parms.rowIndex + ',' + parms.columnIndex,
        type: "text",
        defaultValue: value,
        cellChange: detailChange,
        line: parms.rowIndex,
        bfi: view.bficol[parms.columnIndex - 1]
      });
    }

    // Cause the grid's current input cell to lose focus when scrolling.
    // This allows any changes to be saved.
    var handleGridScroll = function(parms) {
      document.activeElement.blur();
    }

    // Account for change in view by clearing style cache
    function myCellRangeRenderer(props) {
      props.styleCache = [];
      return ReactVirtualized.defaultCellRangeRenderer(props);
    }

    // Display the columnar portion of the edit screen
    var FillColumns = function(page, npage, bficol, collin, refresh) {

      if (page > npage) {
        lineCount = 0;
        rowcount = 2;
      } else {
        lineCount = db1.LineCount(page);
        rowcount = lineCount + 2;
      }

      // Grid parameters
      var gparms = {};
      gparms.className = "detail_grid";
      gparms.cellRangeRenderer = myCellRangeRenderer;
      gparms.cellRenderer = myCellRenderer;
      gparms.rowCount = rowcount;
      gparms.rowHeight = 30;
      gparms.columnCount = collin + 2;
      gparms.columnWidth = getColumnWidth;
      gparms.onScroll = handleGridScroll;
      gparms.ref = function(ref) {
        grid = ref;
      };

      gparms.fixedColumnCount = 1;
      gparms.fixedRowCount = 1;
      gparms.overscanColumnCount = 10;
      gparms.overscanRowCount = 10;
      gparms.enableFixedColumnScroll = true;
      gparms.enableFixedRowScroll = true;
      gparms.hideTopRightGridScrollbar = true;
      gparms.hideBottomLeftGridScrollbar = true;

      if (!refresh) {
        gparms.scrollToRow = 0;
        gparms.scrollToColumn = 0;
        //gparms.scrollLeft = 0;
        refreshNum += 1;
      }
      gparms.refresh = refreshNum;

      // Display the grid
      ReactDOM.render(React.createElement(ReactVirtualized.AutoSizer, null,
        function(params) {
          gparms.height = params.height;
          gparms.width = params.width;
          return React.createElement(ReactVirtualized.MultiGrid, gparms);
        }), document.getElementById('detail'));
    }

    // Previous page
    var leftArrowClick = function() {
      if (--view.curpag < 1) {
        view.curpag = 1;
        return;
      }
      FillHeader(view.curpag, view.npage, view.bfihed, view.hedlin);
      if (view.collin)
        FillColumns(view.curpag, view.npage, view.bficol, view.collin, false);
    }

    // Next page
    var rightArrowClick = function() {
      if (++view.curpag > view.npage)
        view.curpag = view.npage + 1;
      FillHeader(view.curpag, view.npage, view.bfihed, view.hedlin);
      if (view.collin)
        FillColumns(view.curpag, view.npage, view.bficol, view.collin, false);
    }

    var trashClick = function() {
      alert("Trash not yet implemented");
    }

    var searchClick = function() {
      alert("Search not yet implemented");
    }

    var doReport = function() {
      db1.XMLReport(editScreen[currentScreen - 1].name);
    }

    var doExport = function() {
      db1.WriteCsvFile("output.csv", ',');
    }
  </script>
</body>

</html>